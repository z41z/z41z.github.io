{"title":"CentOS利用Certbot申请Let's Encrypt SSL证书并自动续期","date":"2023-08-13T10:49:02.183Z","slug":"auto-renew-letsencrypt-ssl-on-centos","comments":true,"tags":["CentOS","Certbot","Let's Encrypt","LetsEncrypt","Nginx","SSL","证书"],"updated":"2023-11-20T08:07:12.865Z","content":"<ul>\n<li><h5 id=\"0x00：安装Certbot\"><a href=\"#0x00：安装Certbot\" class=\"headerlink\" title=\"0x00：安装Certbot\"></a>0x00：安装Certbot</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install certbot</span><br></pre></td></tr></table></figure>\n<p><div align=\"left\"><img src=\"/images/20230813/certbot.png\" alt=\"certbot\"></div></p>\n</li>\n<li><h5 id=\"0x01：配置Nginx\"><a href=\"#0x01：配置Nginx\" class=\"headerlink\" title=\"0x01：配置Nginx\"></a>0x01：配置Nginx</h5><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span>  /.well-known &#123;</span><br><span class=\"line\">  <span class=\"attribute\">root</span> html;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x02：申请证书\"><a href=\"#0x02：申请证书\" class=\"headerlink\" title=\"0x02：申请证书\"></a>0x02：申请证书</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certbot certonly --webroot --agree-tos -v -t --email <span class=\"built_in\">test</span>@test.com -w /usr/<span class=\"built_in\">local</span>/nginx/html -d www.test.com</span><br></pre></td></tr></table></figure>\n<ul>\n<li><a href=\"mailto:`test@test.com\" target=\"_blank\" rel=\"noopener\">`test@test.com</a>`为你的邮箱地址。</li>\n<li><code>/usr/local/nginx/html</code>为你的<code>Nginx root配置项</code>的路径值。</li>\n<li><code>www.test.com</code>为你的<code>SSL域名</code>，多个域名可以配置多个<code>-d</code>参数。例如<code>-d 1.test.com -d 2.test.com</code></li>\n</ul>\n<p><div align=\"left\"><img src=\"/images/20230813/install.png\" alt=\"install\"></div></p>\n</li>\n<li><h5 id=\"0x03：再次配置Nginx并使用证书\"><a href=\"#0x03：再次配置Nginx并使用证书\" class=\"headerlink\" title=\"0x03：再次配置Nginx并使用证书\"></a>0x03：再次配置Nginx并使用证书</h5><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">ssl_certificate</span> /etc/letsencrypt/live/www.test.com/fullchain.pem;</span><br><span class=\"line\"><span class=\"attribute\">ssl_certificate_key</span> /etc/letsencrypt/live/www.test.com/privkey.pem;</span><br><span class=\"line\"><span class=\"attribute\">ssl_session_timeout</span> <span class=\"number\">5m</span>;</span><br><span class=\"line\"><span class=\"attribute\">ssl_protocols</span> TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\"><span class=\"attribute\">ssl_ciphers</span> AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;</span><br><span class=\"line\"><span class=\"attribute\">ssl_prefer_server_ciphers</span> <span class=\"literal\">on</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x05：重启Nginx\"><a href=\"#0x05：重启Nginx\" class=\"headerlink\" title=\"0x05：重启Nginx\"></a>0x05：重启Nginx</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -s reload</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x06：添加证书刷新任务\"><a href=\"#0x06：添加证书刷新任务\" class=\"headerlink\" title=\"0x06：添加证书刷新任务\"></a>0x06：添加证书刷新任务</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br><span class=\"line\"><span class=\"comment\"># 或者直接编辑文件`/var/spool/cron/root`</span></span><br></pre></td></tr></table></figure>\n<p>写入以下内容（每12小时执行证书刷新检测任务）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0 */12 * * * certbot renew --pre-hook <span class=\"string\">\"nginx stop\"</span> --post-hook <span class=\"string\">\"nginx start\"</span></span><br></pre></td></tr></table></figure>\n<p>重启定时任务服务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service crond restart</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x07：Nginx完整配置\"><a href=\"#0x07：Nginx完整配置\" class=\"headerlink\" title=\"0x07：Nginx完整配置\"></a>0x07：Nginx完整配置</h5><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> www.test.com;</span><br><span class=\"line\">  <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/(.*)</span> https://www.test.com/<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 启用HTTP2</span></span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl http2;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> www.test.com;</span><br><span class=\"line\">  <span class=\"comment\"># 证书路径</span></span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate</span> /etc/letsencrypt/live/www.test.com/fullchain.pem;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate_key</span> /etc/letsencrypt/live/www.test.com/privkey.pem;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_session_timeout</span> <span class=\"number\">5m</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_protocols</span> TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_ciphers</span> AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_prefer_server_ciphers</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">  <span class=\"attribute\">access_log</span> logs/www.test.com.access.log combined;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\"># Let's Encrypt域名所有权校验</span></span><br><span class=\"line\">  <span class=\"attribute\">location</span>  /.well-known &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> html;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x08：常用命令\"><a href=\"#0x08：常用命令\" class=\"headerlink\" title=\"0x08：常用命令\"></a>0x08：常用命令</h5><ul>\n<li><p>查看证书</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certbot certificates</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>删除证书</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certbot delete --cert-name www.test.com</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>释放证书</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certbot revoke --cert-name www.test.com</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>证书签发到指定工作路径</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certbot certonly --webroot --agree-tos -v -t --email <span class=\"built_in\">test</span>@test.com -w /usr/<span class=\"built_in\">local</span>/nginx/html -d www.test.com --config-dir /usr/<span class=\"built_in\">local</span>/nginx/cert</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>刷新证书</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certbot renew</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>刷新指定工作路径下的证书</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certbot renew --config-dir /usr/<span class=\"built_in\">local</span>/nginx/cert</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n","next":{"title":"CentOS常用命令及安装应用指令汇总","slug":"centos-common-shell-command"},"link":"https://www.alipay.one/post/auto-renew-letsencrypt-ssl-on-centos/"}