{"title":"Nginx常用代理场景及常用配置","date":"2020-11-19T01:36:35.044Z","slug":"nginx-common-options","comments":true,"tags":["SPA","client_max_body_size","minio","nginx","proxy_pass","rewrite","upstream","动态代理","单页应用","反向代理","大文件上传","负载均衡"],"updated":"2021-06-21T00:26:09.203Z","content":"<h4 id=\"0x00-常见代理\">0x00: 常见代理<a href=\"post/nginx-common-options#0x00-常见代理\"></a></h4><ul>\n<li><p>代理允许跨域</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> /api_cros &#123;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> <span class=\"string\">'Access-Control-Allow-Origin'</span> <span class=\"string\">'*'</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_pass</span> http://127.0.0.1:8080/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>代理minio</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> /api_minio &#123;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> Host <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">  <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/api_minio/(.*)$</span> /<span class=\"variable\">$1</span> <span class=\"literal\">break</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_pass</span> http://127.0.0.1:9000/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>代理百度地图Web接口</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span><span class=\"regexp\"> ^~/api_baidu_map</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">rewrite</span> <span class=\"regexp\"> ^/api_baidu_map/(.*)$</span> /<span class=\"variable\">$1</span> <span class=\"literal\">break</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_pass</span> http://api.map.baidu.com;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>动态代理IP类接口</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> /&#123;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> X-Scheme <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">  <span class=\"attribute\">if</span> ( <span class=\"variable\">$args</span> <span class=\"regexp\">~ ^url\\=(.*)</span> ) &#123;</span><br><span class=\"line\">    <span class=\"attribute\">set</span> <span class=\"variable\">$url</span> <span class=\"variable\">$1</span>;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_pass</span> <span class=\"variable\">$url</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>调用：<a href=\"http://127.0.0.1/api?url=http://127.0.0.1:8080/api/getList?pageSize=10&amp;pageNum=1\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/api?url=http://127.0.0.1:8080/api/getList?pageSize=10&amp;pageNum=1</a></p>\n</li>\n<li><p>代理超图3D</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> / &#123;    </span><br><span class=\"line\">  <span class=\"attribute\">proxy_hide_header</span> X-Frame-Options;</span><br><span class=\"line\">  <span class=\"attribute\">add_header</span> X-Frame-Options <span class=\"string\">\"\"</span>;    </span><br><span class=\"line\">  <span class=\"attribute\">proxy_pass</span> http://127.0.0.1:8090/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>代理Auth2</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> /api &#123;</span><br><span class=\"line\"> <span class=\"attribute\">if</span> (<span class=\"variable\">$request_method</span> = <span class=\"string\">'OPTIONS'</span>) &#123;</span><br><span class=\"line\">        <span class=\"attribute\">add_header</span> Access-Control-Allow-Origin <span class=\"variable\">$http_origin</span>;</span><br><span class=\"line\">        <span class=\"attribute\">add_header</span> Access-Control-Allow-Headers <span class=\"variable\">$http_access_control_request_headers</span>;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span>;</span><br><span class=\"line\">      &#125; </span><br><span class=\"line\">      <span class=\"attribute\">proxy_pass</span> http://127.0.0.1:8082/;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>代理MySQL</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">stream</span> &#123;</span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">      <span class=\"attribute\">listen</span> <span class=\"number\">13306</span>;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_pass</span> <span class=\"number\">114.114.114.114:3306</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>代理科达地图</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_set_header</span> Accept-Encoding <span class=\"string\">\"\"</span> ;</span><br><span class=\"line\">\t<span class=\"attribute\">sub_filter_once</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">sub_filter_types</span> *;</span><br><span class=\"line\">\t<span class=\"attribute\">sub_filter</span> <span class=\"string\">'KDMAP_SERVER_ADDRESS'</span> <span class=\"string\">'http://127.0.0.1:44444'</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_pass</span> KDMAP_SERVER_ADDRESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h4 id=\"0x01-常用配置\">0x01: 常用配置<a href=\"post/nginx-common-options#0x01-常用配置\"></a></h4><ul>\n<li><p>大文件上传</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">client_max_body_size</span> <span class=\"number\">800m</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>gzip压缩</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">gzip</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_min_length</span> <span class=\"number\">1000</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_buffers</span> <span class=\"number\">4</span> <span class=\"number\">32k</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_proxied</span> any;</span><br><span class=\"line\"><span class=\"attribute\">gzip_types</span> text/plain text/css text/javascript image/jpeg image/gif image/png application/json;</span><br><span class=\"line\"><span class=\"attribute\">gzip_vary</span> <span class=\"literal\">on</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>单页应用(SPA)</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">  <span class=\"attribute\">index</span> index.html;</span><br><span class=\"line\">  <span class=\"comment\">#单页路由刷新404</span></span><br><span class=\"line\">  <span class=\"attribute\">try_files</span> <span class=\"variable\">$uri</span> <span class=\"variable\">$uri</span>/ /index.html;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>多服务实例(负载均衡)</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">upstream</span> API &#123;</span><br><span class=\"line\">  ip_hash;</span><br><span class=\"line\">  <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:8080</span> weight=<span class=\"number\">7</span>;</span><br><span class=\"line\">  <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:8081</span>;</span><br><span class=\"line\">  <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:8082</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>字符串替换</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">sub_filter_once</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"><span class=\"attribute\">sub_filter_types</span> *;</span><br><span class=\"line\"><span class=\"attribute\">sub_filter</span> <span class=\"string\">'baidu.com'</span> <span class=\"string\">'test.baidu.com'</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>rewrite</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span> /order(.*)$ /order.php<span class=\"variable\">$1</span> <span class=\"literal\">last</span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>SSL</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> ssl.siping.one;</span><br><span class=\"line\">  <span class=\"attribute\">access_log</span> logs/ssl.siping.one.access.log;</span><br><span class=\"line\">  <span class=\"attribute\">error_log</span> logs/ssl.siping.one.<span class=\"literal\">error</span>.log;</span><br><span class=\"line\">  <span class=\"attribute\">root</span> /frontend/mobile/next/dist;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate</span> /usr/local/nginx/cert/ssl.siping.one.crt;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate_key</span> /usr/local/nginx/cert/ssl.siping.one.key;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_session_timeout</span> <span class=\"number\">5m</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_protocols</span> TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_ciphers</span> AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_prefer_server_ciphers</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">  <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">    <span class=\"attribute\">try_files</span> <span class=\"variable\">$uri</span> <span class=\"variable\">$uri</span>/ /index.html;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>启用Brotli压缩</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">brotli</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"><span class=\"attribute\">brotli_comp_level</span> <span class=\"number\">6</span>;</span><br><span class=\"line\"><span class=\"attribute\">brotli_buffers</span> <span class=\"number\">16</span> <span class=\"number\">8k</span>;</span><br><span class=\"line\"><span class=\"attribute\">brotli_min_length</span> <span class=\"number\">20</span>;</span><br><span class=\"line\"><span class=\"attribute\">brotli_types</span> text/plain text/css application/json text/javascript image/jpeg image/png;</span><br></pre></td></tr></table></figure>\n<p>参考：<a href=\"/post/compile-nginx-on-centos\">Nginx编译<code>Brotli</code></a></p>\n</li>\n<li><p>重定向</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> ssl.siping.one mobile.siping.one;</span><br><span class=\"line\">  <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/(.*)</span> https://ssl.siping.one/<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>文件包含</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">include</span> conf.d/<span class=\"regexp\">*.conf</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n","prev":{"title":"利用OpenSSL在Window10生成自签名证书","slug":"generate-ssl-for-windows"},"next":{"title":"通过Windows10注册表修改系统服务自启动方式","slug":"windows10-common-regedit-options"},"link":"https://www.alipay.one/post/nginx-common-options/"}