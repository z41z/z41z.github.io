{"title":"Puppeteer应用场景总结","date":"2021-03-10T08:04:10.390Z","slug":"introduce-puppeteer","comments":true,"tags":["Chrome","Google","Puppeteer","pptr"],"updated":"2021-04-25T06:55:33.219Z","content":"<h4 id=\"0x00-介绍\">0x00: 介绍<a href=\"post/introduce-puppeteer#0x00-介绍\"></a></h4><p>Puppeteer是一个通过DevTools协议控制Chromium或Chrome的Node库。</p>\n<h4 id=\"0x01：技术基础\">0x01：技术基础<a href=\"post/introduce-puppeteer#0x01：技术基础\"></a></h4><ul>\n<li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Document_Object_Model/Introduction\" target=\"_blank\" rel=\"noopener\">DOM</a></li>\n<li><a href=\"https://262.ecma-international.org/8.0/\" target=\"_blank\" rel=\"noopener\">JavaScript(ECMAScript 2017/ES8)</a></li>\n</ul>\n<h4 id=\"0x02-下载及安装\">0x02: 下载及安装<a href=\"post/introduce-puppeteer#0x02-下载及安装\"></a></h4>  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 默认下载浏览器,如果使用本地浏览器则安装puppeteer-core包</span><br><span class=\"line\">npm i puppeteer -S</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x03-初始化\">0x03: 初始化<a href=\"post/introduce-puppeteer#0x03-初始化\"></a></h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> pptr = <span class=\"built_in\">require</span>(<span class=\"string\">\"puppeteer-core\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> PUPPETEER_CONFIG = &#123;</span><br><span class=\"line\">  BROWSER_PATH: <span class=\"string\">\"C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\"</span>,</span><br><span class=\"line\">  WIDTH: <span class=\"number\">1920</span>,</span><br><span class=\"line\">  HEIGHT: <span class=\"number\">1080</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* @description 以浏览器模式打开特定网址</span></span><br><span class=\"line\"><span class=\"comment\">* @param &#123;String&#125; url 网址</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> run = <span class=\"keyword\">async</span> (url = <span class=\"string\">\"https://pptr.dev\"</span>) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> &#123; BROWSER_PATH, WIDTH, HEIGHT &#125; = PUPPETEER_CONFIG</span><br><span class=\"line\">  <span class=\"keyword\">const</span> browser = <span class=\"keyword\">await</span> pptr.launch(&#123;</span><br><span class=\"line\">    headless: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    args: [</span><br><span class=\"line\">      <span class=\"comment\">// 浏览器窗口大小</span></span><br><span class=\"line\">      <span class=\"string\">`--window-size=<span class=\"subst\">$&#123;WIDTH&#125;</span>,<span class=\"subst\">$&#123;HEIGHT&#125;</span>`</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    executablePath: BROWSER_PATH,</span><br><span class=\"line\">    <span class=\"comment\">// 视图大小</span></span><br><span class=\"line\">    defaultViewport: &#123;</span><br><span class=\"line\">      width: WIDTH,</span><br><span class=\"line\">      height: HEIGHT</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> page = <span class=\"keyword\">await</span> browser.newPage()</span><br><span class=\"line\">  <span class=\"keyword\">await</span> page.goto(url)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">run(<span class=\"string\">\"https://www.baidu.com\"</span>)</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x04-截图\">0x04: 截图<a href=\"post/introduce-puppeteer#0x04-截图\"></a></h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">await</span> page.screenshot(&#123; <span class=\"attr\">path</span>: <span class=\"string\">'screenshot.png'</span> &#125;)</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x05-导出PDF\">0x05: 导出PDF<a href=\"post/introduce-puppeteer#0x05-导出PDF\"></a></h4><p>需将<code>headless</code>设置为<code>true</code><br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">await</span> page.pdf(&#123; <span class=\"attr\">path</span>: <span class=\"string\">'page.pdf'</span> &#125;)</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"0x06-模拟操作网页\">0x06: 模拟操作网页<a href=\"post/introduce-puppeteer#0x06-模拟操作网页\"></a></h4><p>打开百度搜索<code>Puppeteer</code>后，点击第一个搜索结果<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 输入关键字并回车</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> inputEl = <span class=\"keyword\">await</span> page.$(<span class=\"string\">\"#kw\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">await</span> inputEl.type(<span class=\"string\">'puppeteer'</span>)</span><br><span class=\"line\"><span class=\"keyword\">await</span> page.keyboard.press(<span class=\"string\">'Enter'</span>)</span><br><span class=\"line\"><span class=\"comment\">// 等待结果</span></span><br><span class=\"line\"><span class=\"keyword\">await</span> page.waitForSelector(<span class=\"string\">\".result.new-pmd a\"</span>)</span><br><span class=\"line\"><span class=\"comment\">// 点击第一个搜索结果</span></span><br><span class=\"line\"><span class=\"keyword\">await</span> (<span class=\"keyword\">await</span> page.$(<span class=\"string\">\".result.new-pmd a\"</span>)).click()</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"0x07-注入JavaScript-CSS\">0x07: 注入JavaScript/CSS<a href=\"post/introduce-puppeteer#0x07-注入JavaScript-CSS\"></a></h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">await</span> page.addStyleTag(&#123;</span><br><span class=\"line\">  content: <span class=\"string\">`.c-abstract&#123;color:#666!important;&#125;a&#123;color:#00aeff!important;&#125;#content_right&#123;display:none;&#125;`</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"><span class=\"keyword\">await</span> page.addScriptTag(&#123;</span><br><span class=\"line\">  content: <span class=\"string\">`alert(\"已注入CSS样式，此弹窗通过注入JavaScript弹出\");`</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x08-请求拦截\">0x08: 请求拦截<a href=\"post/introduce-puppeteer#0x08-请求拦截\"></a></h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">await</span> page.setRequestInterception(<span class=\"literal\">true</span>);</span><br><span class=\"line\">page.on(<span class=\"string\">'request'</span>, (request) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> url = request.url()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"regexp\">/sugrec/</span>.test(url)) &#123;</span><br><span class=\"line\">    request.continue(&#123;</span><br><span class=\"line\">      url: url.replace(<span class=\"regexp\">/(puppeteer)/ig</span>, <span class=\"string\">'java'</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    request.continue()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">await</span> inputEl.type(<span class=\"string\">\"请求拦截\"</span>)</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(chalk.green(<span class=\"string\">`请求拦截<span class=\"subst\">$&#123;chalk.yellow(<span class=\"string\">`已将搜索关键字puppeteer替换成java`</span>)&#125;</span>`</span>))</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x09-响应捕获\">0x09: 响应捕获<a href=\"post/introduce-puppeteer#0x09-响应捕获\"></a></h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">page.on(<span class=\"string\">'response'</span>, <span class=\"keyword\">async</span> (response) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> url = response.url()</span><br><span class=\"line\">  <span class=\"keyword\">let</span> text = <span class=\"keyword\">await</span> response.text()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"regexp\">/sugrec/</span>.test(url)) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(chalk.green(<span class=\"string\">`响应捕获到数据：<span class=\"subst\">$&#123;chalk.yellow(<span class=\"string\">`<span class=\"subst\">$&#123;text&#125;</span>`</span>)&#125;</span>`</span>))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x10-响应拦截\">0x10: 响应拦截<a href=\"post/introduce-puppeteer#0x10-响应拦截\"></a></h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">await</span> page.setRequestInterception(<span class=\"literal\">true</span>);</span><br><span class=\"line\">page.on(<span class=\"string\">'request'</span>, (request) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> url = request.url()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"regexp\">/sugrec/</span>.test(url)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 响应拦截</span></span><br><span class=\"line\">    request.respond(&#123;</span><br><span class=\"line\">      status: <span class=\"number\">404</span>,</span><br><span class=\"line\">      body: <span class=\"string\">'拦截404'</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    request.continue()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x11-控制台代码执行\">0x11: 控制台代码执行<a href=\"post/introduce-puppeteer#0x11-控制台代码执行\"></a></h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">await</span> page.evaluate(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">document</span>.querySelectorAll(<span class=\"string\">\"div\"</span>).forEach(<span class=\"function\"><span class=\"params\">item</span> =&gt;</span> &#123;</span><br><span class=\"line\">    item.style.fontSize = <span class=\"string\">'16px'</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x12-案例\">0x12: 案例<a href=\"post/introduce-puppeteer#0x12-案例\"></a></h4><ul>\n<li><h5 id=\"自动化测试\"><a href=\"#自动化测试\" class=\"headerlink\" title=\"自动化测试\"></a>自动化测试</h5></li>\n<li><h5 id=\"富文本导出\"><a href=\"#富文本导出\" class=\"headerlink\" title=\"富文本导出\"></a>富文本导出</h5></li>\n<li><h5 id=\"爬取土地拍卖数据\"><a href=\"#爬取土地拍卖数据\" class=\"headerlink\" title=\"爬取土地拍卖数据\"></a>爬取土地拍卖数据</h5></li>\n<li><h5 id=\"爬取股票数据\"><a href=\"#爬取股票数据\" class=\"headerlink\" title=\"爬取股票数据\"></a>爬取股票数据</h5></li>\n</ul>\n<h4 id=\"0x13：参考\">0x13：参考<a href=\"post/introduce-puppeteer#0x13：参考\"></a></h4><ul>\n<li><a href=\"https://pptr.dev/\" target=\"_blank\" rel=\"noopener\">Puppeteer文档</a></li>\n<li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function\" target=\"_blank\" rel=\"noopener\">async/await说明</a></li>\n<li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Document_Object_Model/Introduction\" target=\"_blank\" rel=\"noopener\">DOM文档</a></li>\n</ul>\n","prev":{"title":"渗透测试(Pentesting)常见案例及复现","slug":"introduce-pentesting"},"next":{"title":"对项目管理、产品、开发、测试及运维规范的一点想法","slug":"project-standard"},"link":"https://www.alipay.one/post/introduce-puppeteer/"}