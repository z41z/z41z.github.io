{"title":"CentOS利用acme.sh申请Let's Encrypt SSL免费证书及通配符域名证书并自动续期","date":"2024-02-20T01:19:40.531Z","slug":"auto-renew-acme-ssl-on-centos","comments":true,"tags":["ACME","CentOS","DNSPod","Let's Encrypt","LetsEncrypt","Nginx","SSL","免费域名证书","腾讯云","证书","通配符证书"],"updated":"2024-02-20T01:24:27.465Z","content":"<ul>\n<li><h5 id=\"0x00-安装acme-sh\"><a href=\"#0x00-安装acme-sh\" class=\"headerlink\" title=\"0x00.安装acme.sh\"></a>0x00.安装acme.sh</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://get.acme.sh | sh -s email=<span class=\"built_in\">test</span>@test.com</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Github安装acme.sh<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/acmesh-official/acme.sh.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> acme.sh</span><br><span class=\"line\">./acme.sh --install -m <span class=\"built_in\">test</span>@test.com</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><h5 id=\"0x01-设置证书签发商\"><a href=\"#0x01-设置证书签发商\" class=\"headerlink\" title=\"0x01.设置证书签发商\"></a>0x01.设置证书签发商</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --<span class=\"built_in\">set</span>-default-ca --server letsencrypt</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x02-设置腾讯云密钥\"><a href=\"#0x02-设置腾讯云密钥\" class=\"headerlink\" title=\"0x02.设置腾讯云密钥\"></a>0x02.设置腾讯云密钥</h5><p><a href=\"https://console.dnspod.cn/account/token/apikey\" target=\"_blank\" rel=\"noopener\">https://console.dnspod.cn/account/token/apikey</a><br><code>其他DNS提供商见官方文档</code><a href=\"https://github.com/acmesh-official/acme.sh\" target=\"_blank\" rel=\"noopener\">https://github.com/acmesh-official/acme.sh</a></p>\n</li>\n<li><h5 id=\"0x03-设置环境变量\"><a href=\"#0x03-设置环境变量\" class=\"headerlink\" title=\"0x03.设置环境变量\"></a>0x03.设置环境变量</h5><p>编辑<code>/etc/bashrc</code>并写入</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> Tencent_SecretId=<span class=\"string\">\"Tencent_SecretId\"</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> Tencent_SecretKey=<span class=\"string\">\"Tencent_SecretKey\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x04-申请证书\"><a href=\"#0x04-申请证书\" class=\"headerlink\" title=\"0x04.申请证书\"></a>0x04.申请证书</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># dns_tencent为腾讯云api</span></span><br><span class=\"line\">acme.sh --issue --dns dns_tencent -d *.test.com --key-file /nginx/certs/test.com.key.pem --fullchain-file /nginx/certs/test.com.cert.pem --post-hook <span class=\"string\">\"nginx -s reload\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x05-查看证书\"><a href=\"#0x05-查看证书\" class=\"headerlink\" title=\"0x05.查看证书\"></a>0x05.查看证书</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --list</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x06-释放证书\"><a href=\"#0x06-释放证书\" class=\"headerlink\" title=\"0x06.释放证书\"></a>0x06.释放证书</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --revoke -d test.com</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x07-移除证书\"><a href=\"#0x07-移除证书\" class=\"headerlink\" title=\"0x07.移除证书\"></a>0x07.移除证书</h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --remove -d test.com</span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"0x08：Nginx完整配置\"><a href=\"#0x08：Nginx完整配置\" class=\"headerlink\" title=\"0x08：Nginx完整配置\"></a>0x08：Nginx完整配置</h5><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> www.test.com;</span><br><span class=\"line\">  <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/(.*)</span> https://www.test.com/<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 启用HTTP2</span></span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl http2;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> www.test.com;</span><br><span class=\"line\">  <span class=\"comment\"># 证书路径</span></span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate</span> /nginx/certs/test.com.cert.pem;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate_key</span> /nginx/certs/test.com.key.pem;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_session_timeout</span> <span class=\"number\">5m</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_protocols</span> TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_ciphers</span> AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_prefer_server_ciphers</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">  <span class=\"attribute\">access_log</span> logs/www.test.com.access.log combined;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n","next":{"title":"CentOS利用Certbot、acme.sh申请Let's Encrypt SSL免费证书及通配符域名证书并自动续期","slug":"auto-renew-letsencrypt-ssl-on-centos"},"link":"https://www.alipay.one/post/auto-renew-acme-ssl-on-centos/"}