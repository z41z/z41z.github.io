{"title":"通过Puppeteer获取或者导出网页富文本内容","date":"2020-12-24T03:42:56.633Z","slug":"export-rich-text-to-pdf-by-puppeteer","comments":true,"tags":["Docker","Express","Pug","Puppeteer","async/await","nodejs","富文本导出"],"updated":"2020-12-26T05:14:59.038Z","content":"<h4 id=\"Puppeteer介绍\">Puppeteer介绍<a href=\"post/export-rich-text-to-pdf-by-puppeteer#Puppeteer介绍\"></a></h4><p><a href=\"https://pptr.dev/\" target=\"_blank\" rel=\"noopener\">Puppeteer</a> 是 Chrome 开发团队在 2017 年发布的一个 Node.js 包，用来模拟 Chrome 浏览器的运行。</p>\n<h4 id=\"应用场景\">应用场景<a href=\"post/export-rich-text-to-pdf-by-puppeteer#应用场景\"></a></h4><ul>\n<li>自动化测试</li>\n<li>爬虫</li>\n<li>网页/富文本截图或导出</li>\n<li>自动化代码注入</li>\n</ul>\n<h4 id=\"代码检出\">代码检出<a href=\"post/export-rich-text-to-pdf-by-puppeteer#代码检出\"></a></h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/z41z/pptr-online</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装依赖\">安装依赖<a href=\"post/export-rich-text-to-pdf-by-puppeteer#安装依赖\"></a></h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm i</span><br></pre></td></tr></table></figure>\n<h4 id=\"运行\">运行<a href=\"post/export-rich-text-to-pdf-by-puppeteer#运行\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm run start // 或者npm run dev</span><br></pre></td></tr></table></figure>\n<p>运行成功后用浏览器打开<code>http://localhost:3000</code>即可。</p>\n<h4 id=\"使用\">使用<a href=\"post/export-rich-text-to-pdf-by-puppeteer#使用\"></a></h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl <span class=\"string\">\"http://localhost:3000/screenshot?type=image\"</span> -o screenshot.png</span><br><span class=\"line\">curl -X POST <span class=\"string\">\"http://localhost:3000/screenshot\"</span> -H <span class=\"string\">\"Content-Type: application/json\"</span> --data <span class=\"string\">\"&#123;\\\"type\\\":\\\"image\\\",\\\"encoding\\\":\\\"base64\\\"&#125;\"</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"部署\">部署<a href=\"post/export-rich-text-to-pdf-by-puppeteer#部署\"></a></h4><ul>\n<li>本地化部署：直接将项目运行起来即可。</li>\n<li>容器化部署<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> node:latest</span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> ./ /pptr_online</span></span><br><span class=\"line\"><span class=\"comment\"># 拷贝Windows字体到容器，需将字体文件放Fonts目录</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> fonts /usr/share/fonts</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"bash\"> /pptr_online</span></span><br><span class=\"line\"><span class=\"comment\"># 安装必备包</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> apt update&amp;&amp;apt-get install -y libatk-bridge2.0.0 libgtk-3.0 fontconfig libnss3-dev libasound2</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> npm config <span class=\"built_in\">set</span> puppeteer_download_host=https://storage.googleapis.com.cnpmjs.org</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> npm i</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"bash\"> /pptr_online/src</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [ <span class=\"string\">\"node\"</span>,<span class=\"string\">\"server.js\"</span> ]</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">3000</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h4 id=\"参数说明\">参数说明<a href=\"post/export-rich-text-to-pdf-by-puppeteer#参数说明\"></a></h4><ul>\n<li>url<br>网页地址,需要url编码</li>\n<li>type<br>导出类型(可选<code>image</code>,<code>pdf</code>,<code>text</code>)</li>\n<li>selector<br>导出选择器内容(需要url编码,例如#s-top-left &gt; a:nth-child(6)编码为%23s-top-left%20&gt;%20a%3Anth-child(6)),默认值<code>html</code>,<code>pdf</code>指定选择器时样式会丢失</li>\n<li>width<br>页面视口宽度(type为<code>image</code>时且指定了<code>full</code>时不生效)</li>\n<li>height<br>页面视口高度(type为<code>image</code>时且指定了<code>full</code>时不生效)</li>\n<li>encoding<br>图片导出方式(可选值<code>base64</code>,<code>binary</code>,type为<code>image</code>时生效)</li>\n<li>full<br>图片全屏导出(默认<code>视口[非全屏]</code>导出,填写<code>任意值</code>则为全屏导出,type为<code>image</code>时生效)</li>\n<li>headers<br>请求头(必须为<code>JSON字符串</code>)</li>\n<li>js<br>注入的JavaScript代码</li>\n<li>displayHeaderFooter<br>是否显示页眉和页脚(传任意值则显示页眉页脚type为<code>pdf</code>有效)</li>\n<li>headerTemplate<br>页眉模板(type为<code>pdf</code>且<code>displayHeaderFooter</code>为<code>true</code>有效,富文本标签[其中<code>class</code>值取<code>date</code>,<code>title</code>,<code>url</code>,<code>pageNumber</code>,<code>totalPages</code>时可取对应的值])</li>\n<li>footerTemplate<br>页脚模板(type为<code>pdf</code>且<code>displayHeaderFooter</code>为<code>true</code>有效,富文本标签[其中<code>class</code>值取<code>date</code>,<code>title</code>,<code>url</code>,<code>pageNumber</code>,<code>totalPages</code>时可取对应的值])</li>\n<li>margin<br>页边距(type为<code>pdf</code>有效),默认上下边距<code>50px</code>,可修改。例如:<code>{top:&#39;20px&#39;,right:&#39;20px&#39;,bottom:&#39;20px&#39;,left:&#39;20px&#39;}</code></li>\n</ul>\n<h4 id=\"获取网页选择器的内容\">获取网页选择器的内容<a href=\"post/export-rich-text-to-pdf-by-puppeteer#获取网页选择器的内容\"></a></h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> exportPdfPost = <span class=\"keyword\">async</span> (options = &#123;&#125;) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data = <span class=\"string\">''</span></span><br><span class=\"line\">  data = <span class=\"keyword\">await</span> fetch(<span class=\"string\">`http://localhost:3000/screenshot?url=https://www.baidu.com/&amp;type=text&amp;selector=%23hotsearch-content-wrapper%20&gt;%20li%3Anth-child(4)%20&gt;%20a%20&gt;%20span.title-content-title`</span>, &#123;</span><br><span class=\"line\">    method: <span class=\"string\">'GET'</span></span><br><span class=\"line\">  &#125;).then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res.text()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  <span class=\"comment\">// \"2021春运将从1月28日开始\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"POST请求文件下载\">POST请求文件下载<a href=\"post/export-rich-text-to-pdf-by-puppeteer#POST请求文件下载\"></a></h4><ul>\n<li><p>文件下载</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> exportPDF = <span class=\"function\">(<span class=\"params\">options = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> data = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"url\"</span>: <span class=\"built_in\">encodeURIComponent</span>(<span class=\"string\">\"https://www.secpulse.com/archives/107874.html\"</span>),</span><br><span class=\"line\">    <span class=\"string\">\"type\"</span>: <span class=\"string\">\"image\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"encoding\"</span>: <span class=\"string\">\"binary\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"selector\"</span>: <span class=\"built_in\">encodeURIComponent</span>(<span class=\"string\">\".left-9-article\"</span>),</span><br><span class=\"line\">    <span class=\"string\">\"js\"</span>: <span class=\"string\">\"console.log('test')\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> fetch(<span class=\"string\">`/sceenshot`</span>, &#123;</span><br><span class=\"line\">    method: <span class=\"string\">'POST'</span>,</span><br><span class=\"line\">    body: <span class=\"built_in\">JSON</span>.stringify(data),</span><br><span class=\"line\">    headers: <span class=\"keyword\">new</span> Headers(&#123;</span><br><span class=\"line\">      <span class=\"string\">'Content-Type'</span>: <span class=\"string\">'application/json'</span></span><br><span class=\"line\">    &#125;),</span><br><span class=\"line\">  &#125;).then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res.blob()</span><br><span class=\"line\">  &#125;).then(<span class=\"function\"><span class=\"params\">blob</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> link = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'a'</span>);</span><br><span class=\"line\">    link.href = <span class=\"built_in\">window</span>.URL.createObjectURL(blob);</span><br><span class=\"line\">    link.download = <span class=\"built_in\">decodeURI</span>(<span class=\"string\">'export.png'</span>)</span><br><span class=\"line\">    link.click();</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>结果如下：<br><img src=\"./../images/httpswww.secpulse.com_archives_107874.html.png\" alt=\"secpulse\"></p>\n<h4 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h4><ul>\n<li><a href=\"https://pptr.dev/\" target=\"_blank\" rel=\"noopener\">Puppeteer文档</a></li>\n<li><a href=\"https://github.com/puppeteer/puppeteer\" target=\"_blank\" rel=\"noopener\">Puppeteer仓库</a></li>\n<li><a href=\"https://nodejs.org/en/docs/\" target=\"_blank\" rel=\"noopener\">Node.js</a></li>\n<li><a href=\"https://expressjs.com/zh-cn/\" target=\"_blank\" rel=\"noopener\">Express</a></li>\n<li><a href=\"https://pugjs.org/\" target=\"_blank\" rel=\"noopener\">Pug</a></li>\n<li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API\" target=\"_blank\" rel=\"noopener\">MDN</a></li>\n<li><a href=\"https://yeasy.gitbook.io/docker_practice/\" target=\"_blank\" rel=\"noopener\">Docker手册</a></li>\n</ul>\n</li>\n</ul>\n","next":{"title":"CentOS安装Cockpit管理主机","slug":"install-cockpit-on-centos"},"link":"https://www.alipay.one/post/export-rich-text-to-pdf-by-puppeteer/"}