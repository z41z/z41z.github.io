{"title":"CentOS编译安装Nginx并启用Brotli压缩和HTTP2","date":"2021-06-17T08:46:49.511Z","slug":"compile-nginx-on-centos","comments":true,"tags":["Brotli","CentOS","HTTP2","SSL","nginx","nginx编译"],"updated":"2021-07-20T08:05:15.270Z","content":"<h4 id=\"0x00：编译并安装Nginx\">0x00：编译并安装Nginx<a href=\"post/compile-nginx-on-centos#0x00：编译并安装Nginx\"></a></h4><h5 id=\"下载Nginx包\">下载Nginx包<a href=\"post/compile-nginx-on-centos#下载Nginx包\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://nginx.org/download/nginx-1.21.0.tar.gz</span><br></pre></td></tr></table></figure>\n<h5 id=\"安装依赖\">安装依赖<a href=\"post/compile-nginx-on-centos#安装依赖\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install gcc gcc-c++ automake zlib zlib-devel \\</span><br><span class=\"line\">openssl openssl-devel pcre pcre-devel</span><br></pre></td></tr></table></figure>\n<h5 id=\"解压\">解压<a href=\"post/compile-nginx-on-centos#解压\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -zxvf nginx-1.21.0.tar.gz</span><br></pre></td></tr></table></figure>\n<h5 id=\"生成Makefile\">生成Makefile<a href=\"post/compile-nginx-on-centos#生成Makefile\"></a></h5><p>进入解压后的文件夹运行<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure</span><br></pre></td></tr></table></figure></p>\n<h5 id=\"编译安装\">编译安装<a href=\"post/compile-nginx-on-centos#编译安装\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make</span><br><span class=\"line\">make install</span><br></pre></td></tr></table></figure>\n<p>Tips:编译后的文件路径<code>/usr/local/nginx</code></p>\n<h5 id=\"添加软链\">添加软链<a href=\"post/compile-nginx-on-centos#添加软链\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -s /usr/<span class=\"built_in\">local</span>/nginx/sbin/nginx /usr/bin/nginx</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x01：启用Brotli压缩和HTTP2\">0x01：启用Brotli压缩和HTTP2<a href=\"post/compile-nginx-on-centos#0x01：启用Brotli压缩和HTTP2\"></a></h4><h5 id=\"安装Git\">安装Git<a href=\"post/compile-nginx-on-centos#安装Git\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install git</span><br></pre></td></tr></table></figure>\n<h5 id=\"安装OpenSSL\">安装OpenSSL<a href=\"post/compile-nginx-on-centos#安装OpenSSL\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure>\n<h5 id=\"下载Brotli模块\">下载Brotli模块<a href=\"post/compile-nginx-on-centos#下载Brotli模块\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/google/ngx_brotli.git</span><br></pre></td></tr></table></figure>\n<h5 id=\"编译Nginx并添加Brotli模块和http-ssl-module模块\">编译Nginx并添加Brotli模块和http_ssl_module模块<a href=\"post/compile-nginx-on-centos#编译Nginx并添加Brotli模块和http-ssl-module模块\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ./ngx_brotli &amp;&amp; git submodule update --init &amp;&amp; <span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/nginx-1.21.0</span><br><span class=\"line\">./configure --add-dynamic-module=./ngx_brotli --prefix=/usr/<span class=\"built_in\">local</span>/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_v2_module --with-stream --with-http_sub_module</span><br><span class=\"line\">make install</span><br></pre></td></tr></table></figure>\n<h4 id=\"修改nginx-conf并启用Brotli\">修改nginx.conf并启用Brotli<a href=\"post/compile-nginx-on-centos#修改nginx-conf并启用Brotli\"></a></h4><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置文件中添加</span></span><br><span class=\"line\"><span class=\"attribute\">worker_processes</span>  <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"attribute\">load_module</span> modules/ngx_http_brotli_filter_module.so;</span><br><span class=\"line\"><span class=\"attribute\">load_module</span> modules/ngx_http_brotli_static_module.so;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">worker_connections</span>  <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">include</span>       mime.types;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span>  application/octet-stream;</span><br><span class=\"line\">    <span class=\"attribute\">sendfile</span>        <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">keepalive_timeout</span>  <span class=\"number\">65</span>;</span><br><span class=\"line\">    <span class=\"attribute\">brotli</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">brotli_comp_level</span> <span class=\"number\">6</span>;</span><br><span class=\"line\">    <span class=\"attribute\">brotli_buffers</span> <span class=\"number\">16</span> <span class=\"number\">8k</span>;</span><br><span class=\"line\">    <span class=\"attribute\">brotli_min_length</span> <span class=\"number\">20</span>;</span><br><span class=\"line\">    <span class=\"attribute\">brotli_types</span> text/plain text/css application/json text/javascript image/jpeg image/png;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"comment\"># 启用HTTP2</span></span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">443</span> ssl http2;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_certificate</span> /usr/local/nginx-<span class=\"number\">1</span>.<span class=\"number\">21</span>.<span class=\"number\">0</span>/cert/test.crt;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_certificate_key</span> /usr/local/nginx-<span class=\"number\">1</span>.<span class=\"number\">21</span>.<span class=\"number\">0</span>/cert/test.key;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_session_timeout</span> <span class=\"number\">5m</span>;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_protocols</span> TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_ciphers</span> AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_prefer_server_ciphers</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>####</p>\n<h5 id=\"运行Nginx\">运行Nginx<a href=\"post/compile-nginx-on-centos#运行Nginx\"></a></h5><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x02：结果\">0x02：结果<a href=\"post/compile-nginx-on-centos#0x02：结果\"></a></h4><div class=\"article-img\"><p><img src=\"/images/20210617/nginx-br-h2.png\" alt=\"ssl\" data-zoomable></p></div>\n","prev":{"title":"Windows环境下编译Nginx并开启HTTP2","slug":"compile-nginx-on-windows"},"next":{"title":"渗透测试(Pentesting)常见案例及复现","slug":"introduce-pentesting"},"link":"https://www.alipay.one/post/compile-nginx-on-centos/"}